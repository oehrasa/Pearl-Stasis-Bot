name: Run Private Bot

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'

permissions:
  contents: none

concurrency:
  group: bot-runner
  cancel-in-progress: false   # new runs wait until the old one finishes

jobs:
  run-bot:
    runs-on: ubuntu-latest

    steps:
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          eval "$(ssh-agent -s)"
          ssh-add ~/.ssh/id_ed25519
          ssh-keyscan github.com >> ~/.ssh/known_hosts

      - name: Clone private repo
        run: |
          git clone git@github.com:oehrasa/Shush-its-a-secret.git
          cd Shush-its-a-secret
          ls -la

      - name: Install dependencies
        run: |
          cd Shush-its-a-secret
          npm ci || npm install

      - name: Run bot
        run: |
          cd Shush-its-a-secret
          node fio.js   # entry point of your bot

      - name: Commit & push changes
        if: always()
        run: |
          cd Shush-its-a-secret
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          if [ -f "oehbot-log.txt" ]; then git add oehbot-log.txt; fi
          if [ -f "data/pearls.json" ]; then git add data/pearls.json; fi
          git commit -m "Update log and pearls.json [skip ci]" || echo "No changes to commit"
          git push origin main

      - name: Trigger next run
        if: always()
        run: |
          curl -X POST \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/${{ github.repository }}/actions/workflows/Run%20Private%20Bot.yml/dispatches \
            -d '{"ref":"main"}'
